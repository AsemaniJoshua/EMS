function fetchResults(){const resultsTable=document.getElementById("resultsTable");resultsTable.innerHTML='\n        <tr>\n            <td colspan="8" class="px-6 py-4 text-center">\n                <div class="flex justify-center items-center">\n                    <i class="fas fa-spinner fa-spin mr-2 text-emerald-500"></i>\n                    <span class="text-gray-500">Loading results...</span>\n                </div>\n            </td>\n        </tr>\n    ';const form=document.getElementById("filterForm"),formData=new FormData(form);formData.append("page",currentPage),formData.append("resultsPerPage",resultsPerPage),fetch("../../api/results/getResults.php",{method:"POST",body:formData}).then((response=>{if(!response.ok)throw new Error("Network response was not ok");return response.json()})).then((data=>{data.success?(populateResults(data.results),updatePagination(data.pagination)):(showNotification(data.message||"Failed to load results","error"),resultsTable.innerHTML=`\n                <tr>\n                    <td colspan="8" class="px-6 py-4 text-center text-red-500">\n                        <i class="fas fa-exclamation-triangle mr-2"></i>\n                        Error: ${data.message||"Failed to load results"}\n                    </td>\n                </tr>\n            `)})).catch((error=>{console.error("Error:",error),showNotification("Failed to load results","error"),resultsTable.innerHTML='\n            <tr>\n                <td colspan="8" class="px-6 py-4 text-center text-red-500">\n                    <i class="fas fa-exclamation-triangle mr-2"></i>\n                    Failed to load results. Please try again.\n                </td>\n            </tr>\n        '}))}function populateResults(results){const resultsTable=document.getElementById("resultsTable");resultsTable.innerHTML="",results&&0!==results.length?results.forEach((result=>{const row=document.createElement("tr"),statusClass=result.score_percentage>=50?"bg-green-100 text-green-800":"bg-red-100 text-red-800";row.innerHTML=`\n            <td class="px-6 py-4 whitespace-nowrap">\n                <div class="flex items-center">\n                    <div class="text-sm font-medium text-gray-900">${escapeHtml(result.student_name)}</div>\n                </div>\n                <div class="text-xs text-gray-500">${escapeHtml(result.index_number||"")}</div>\n            </td>\n            <td class="px-6 py-4 whitespace-nowrap">\n                <div class="text-sm text-gray-900">${escapeHtml(result.exam_title)}</div>\n                <div class="text-xs text-gray-500">Code: ${escapeHtml(result.exam_code)}</div>\n            </td>\n            <td class="px-6 py-4 whitespace-nowrap">\n                <div class="text-sm text-gray-900">${escapeHtml(result.course_code||"")}</div>\n                <div class="text-xs text-gray-500">${escapeHtml(result.course_title||"")}</div>\n            </td>\n            <td class="px-6 py-4 whitespace-nowrap">\n                <div class="text-sm text-gray-900">${result.completed_at}</div>\n            </td>\n            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">\n                ${result.score_percentage.toFixed(1)}%\n            </td>\n            <td class="px-6 py-4 whitespace-nowrap text-sm">\n                ${result.correct_answers} / ${result.total_questions}\n            </td>\n            <td class="px-6 py-4 whitespace-nowrap">\n                <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${statusClass}">\n                    ${result.score_percentage>=50?"Passed":"Failed"}\n                </span>\n            </td>\n            <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">\n                <button \n                    onclick="viewResultDetails(${result.result_id})" \n                    class="text-indigo-600 hover:text-indigo-900 mr-3">\n                    <i class="fas fa-eye mr-1"></i> View\n                </button>\n                <a \n                    href="../../api/results/printResult.php?result_id=${result.result_id}" \n                    target="_blank" \n                    class="text-green-600 hover:text-green-900">\n                    <i class="fas fa-print mr-1"></i> Print\n                </a>\n            </td>\n        `,resultsTable.appendChild(row)})):resultsTable.innerHTML='\n            <tr>\n                <td colspan="8" class="px-6 py-4 text-center text-gray-500">\n                    <i class="fas fa-search mr-2"></i>\n                    No results found matching your criteria.\n                </td>\n            </tr>\n        '}function updatePagination(pagination){if(!pagination)return;const{currentPage:currentPage,totalPages:totalPages,totalResults:totalResults,firstResult:firstResult,lastResult:lastResult}=pagination;document.getElementById("firstResult").textContent=firstResult,document.getElementById("lastResult").textContent=lastResult,document.getElementById("totalResults").textContent=totalResults,document.getElementById("resultCount").textContent=`${totalResults} results`,document.getElementById("prevPage").disabled=currentPage<=1,document.getElementById("nextPage").disabled=currentPage>=totalPages}function exportResults(){showNotification("Preparing export, please wait...","info");const form=document.getElementById("filterForm"),formData=new FormData(form);fetch("../../api/results/exportResults.php",{method:"POST",body:formData}).then((response=>{if(!response.ok)throw new Error("Network response was not ok");return response.blob()})).then((blob=>{const url=window.URL.createObjectURL(blob),a=document.createElement("a");a.style.display="none",a.href=url,a.download="exam_results_export.csv",document.body.appendChild(a),a.click(),window.URL.revokeObjectURL(url),a.remove(),showNotification("Export complete!","success")})).catch((error=>{console.error("Error:",error),showNotification("Failed to export results","error")}))}function generateReport(){showNotification("Generating report, please wait...","info");const form=document.getElementById("filterForm"),formData=new FormData(form);fetch("../../api/results/generateReport.php",{method:"POST",body:formData}).then((response=>{if(!response.ok)throw new Error("Network response was not ok");return response.blob()})).then((blob=>{const url=window.URL.createObjectURL(blob);window.open(url,"_blank"),setTimeout((()=>{window.URL.revokeObjectURL(url)}),1e3),showNotification("Report generated successfully!","success")})).catch((error=>{console.error("Error:",error),showNotification("Failed to generate report","error")}))}function viewResultDetails(resultId){const modal=document.getElementById("resultModal"),modalContent=document.getElementById("modalContent");modal.classList.remove("hidden"),modalContent.innerHTML='\n        <div class="flex justify-center items-center py-10">\n            <i class="fas fa-spinner fa-spin mr-2 text-emerald-500 text-2xl"></i>\n            <span class="text-gray-500">Loading result details...</span>\n        </div>\n    ',fetch(`../../api/results/getResultDetails.php?result_id=${resultId}`).then((response=>{if(!response.ok)throw new Error("Network response was not ok");return response.json()})).then((data=>{if(!data.success)throw new Error(data.message||"Failed to load result details");const result=data.result,questions=data.questions||[],isPassed=result.score_percentage>=50,statusClass=isPassed?"bg-green-100 text-green-800":"bg-red-100 text-red-800";let html=`\n            <div class="mb-6">\n                <h4 class="text-lg font-medium text-gray-900 mb-1">${escapeHtml(result.exam_title)}</h4>\n                <p class="text-sm text-gray-500">Completed on ${result.completed_at}</p>\n            </div>\n            \n            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">\n                <div>\n                    <h5 class="text-sm font-medium text-gray-700 mb-2">Student Information</h5>\n                    <div class="bg-gray-50 p-3 rounded-lg">\n                        <p><span class="font-medium">Name:</span> ${escapeHtml(result.student_name)}</p>\n                        <p><span class="font-medium">ID:</span> ${escapeHtml(result.index_number||"")}</p>\n                        <p><span class="font-medium">Program:</span> ${escapeHtml(result.program_name)}</p>\n                    </div>\n                </div>\n                \n                <div>\n                    <h5 class="text-sm font-medium text-gray-700 mb-2">Exam Information</h5>\n                    <div class="bg-gray-50 p-3 rounded-lg">\n                        <p><span class="font-medium">Course:</span> ${escapeHtml(result.course_code)} - ${escapeHtml(result.course_title)}</p>\n                        <p><span class="font-medium">Department:</span> ${escapeHtml(result.department_name)}</p>\n                        <p><span class="font-medium">Exam Code:</span> ${escapeHtml(result.exam_code)}</p>\n                    </div>\n                </div>\n            </div>\n            \n            <div class="bg-gray-50 p-4 rounded-lg text-center mb-6">\n                <p class="text-2xl font-bold ${isPassed?"text-green-700":"text-red-700"}">${result.score_percentage.toFixed(1)}%</p>\n                <p class="text-gray-600">${result.correct_answers} correct out of ${result.total_questions} questions</p>\n                <p class="mt-2">\n                    <span class="px-3 py-1 rounded-full ${statusClass}">\n                        ${isPassed?"PASSED":"FAILED"}\n                    </span>\n                </p>\n            </div>\n        `;questions.length>0&&(html+='\n                <h5 class="font-medium text-gray-800 mb-3">Question Analysis</h5>\n                <div class="space-y-4 mb-6">\n            ',questions.forEach(((question,index)=>{const isCorrect=question.is_correct;html+=`\n                    <div class="border rounded-lg overflow-hidden">\n                        <div class="px-4 py-2 bg-gray-50 border-b">\n                            <p class="font-medium">Question ${question.sequence_number||index+1}</p>\n                        </div>\n                        <div class="p-4">\n                            <p class="mb-3">${escapeHtml(question.question_text)}</p>\n                            \n                            <div class="mb-2 ${isCorrect?"bg-green-50 border-l-4 border-green-500":"bg-red-50 border-l-4 border-red-500"} p-2">\n                                <p class="text-sm">\n                                    <span class="font-medium">Your answer:</span> ${escapeHtml(question.student_answer)}\n                                    ${isCorrect?'<span class="text-green-700 ml-2"><i class="fas fa-check"></i> Correct</span>':'<span class="text-red-700 ml-2"><i class="fas fa-times"></i> Incorrect</span>'}\n                                </p>\n                            </div>\n                            \n                            ${isCorrect?"":`\n                                <div class="bg-green-50 border-l-4 border-green-500 p-2">\n                                    <p class="text-sm">\n                                        <span class="font-medium">Correct answer:</span> ${escapeHtml(question.correct_answer)}\n                                    </p>\n                                </div>\n                            `}\n                        </div>\n                    </div>\n                `})),html+="</div>"),html+=`\n            <div class="flex justify-end pt-4 border-t border-gray-200">\n                <a \n                    href="../../api/results/printResult.php?result_id=${resultId}" \n                    target="_blank" \n                    class="bg-emerald-600 hover:bg-emerald-700 text-white px-4 py-2 rounded-lg transition-colors duration-200 flex items-center mr-3">\n                    <i class="fas fa-print mr-2"></i>\n                    Print Report\n                </a>\n                <button \n                    onclick="document.getElementById('resultModal').classList.add('hidden')" \n                    class="bg-gray-200 hover:bg-gray-300 text-gray-800 px-4 py-2 rounded-lg transition-colors duration-200">\n                    Close\n                </button>\n            </div>\n        `,modalContent.innerHTML=html})).catch((error=>{console.error("Error:",error),modalContent.innerHTML=`\n            <div class="text-center py-10">\n                <i class="fas fa-exclamation-triangle text-3xl text-red-500 mb-3"></i>\n                <p class="text-red-600 font-medium">Failed to load result details</p>\n                <p class="text-gray-500 mt-1">${error.message||"Please try again"}</p>\n                <button \n                    onclick="document.getElementById('resultModal').classList.add('hidden')" \n                    class="mt-4 bg-gray-200 hover:bg-gray-300 text-gray-800 px-4 py-2 rounded-lg transition-colors duration-200">\n                    Close\n                </button>\n            </div>\n        `}))}function showNotification(message,type="info"){const colors={success:"bg-green-500",error:"bg-red-500",info:"bg-blue-500",warning:"bg-yellow-500"},toast=document.createElement("div");toast.className=`fixed top-5 right-5 px-6 py-3 rounded shadow-lg text-white z-50 ${colors[type]||colors.info}`,toast.innerHTML=`\n        <div class="flex items-center">\n            <i class="fas fa-${"success"===type?"check-circle":"error"===type?"exclamation-circle":"info-circle"} mr-2"></i>\n            <span>${message}</span>\n        </div>\n    `,document.body.appendChild(toast),setTimeout((()=>{toast.classList.add("opacity-0","transition-opacity"),setTimeout((()=>toast.remove()),300)}),3e3)}function escapeHtml(unsafe){return null==unsafe?"":String(unsafe).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;")}document.addEventListener("DOMContentLoaded",(function(){let currentPage=1;fetchResults(),document.getElementById("filterButton").addEventListener("click",(function(){currentPage=1,fetchResults()})),document.getElementById("exportResultsBtn").addEventListener("click",exportResults),document.getElementById("generateReportBtn").addEventListener("click",generateReport),document.getElementById("prevPage").addEventListener("click",(function(){currentPage>1&&(currentPage--,fetchResults())})),document.getElementById("nextPage").addEventListener("click",(function(){currentPage++,fetchResults()})),document.getElementById("closeModal").addEventListener("click",(function(){document.getElementById("resultModal").classList.add("hidden")})),document.getElementById("resultModal").addEventListener("click",(function(event){event.target===this&&this.classList.add("hidden")})),document.getElementById("filterDepartment").addEventListener("change",(function(){const departmentId=this.value,programSelect=document.getElementById("filterProgram"),courseSelect=document.getElementById("filterCourse");programSelect.innerHTML='<option value="">All Programs</option>',courseSelect.innerHTML='<option value="">All Courses</option>',departmentId&&(programSelect.disabled=!0,axios.get("../../api/exams/getProgramsByDepartment.php",{params:{departmentId:departmentId}}).then((response=>{if(response.data.success){response.data.programs.forEach((program=>{const option=document.createElement("option");option.value=program.program_id,option.textContent=program.name,programSelect.appendChild(option)}))}programSelect.disabled=!1})).catch((error=>{console.error("Error fetching programs:",error),showNotification("Failed to load programs","error"),programSelect.disabled=!1})))})),document.getElementById("filterProgram").addEventListener("change",(function(){const programId=this.value,departmentId=document.getElementById("filterDepartment").value,courseSelect=document.getElementById("filterCourse");courseSelect.innerHTML='<option value="">All Courses</option>',programId&&(courseSelect.disabled=!0,axios.get("../../api/exams/getCoursesByProgram.php",{params:{programId:programId,departmentId:departmentId}}).then((response=>{if(response.data.success){response.data.courses.forEach((course=>{const option=document.createElement("option");option.value=course.course_id,option.textContent=`${course.code} - ${course.title}`,courseSelect.appendChild(option)}))}courseSelect.disabled=!1})).catch((error=>{console.error("Error fetching courses:",error),showNotification("Failed to load courses","error"),courseSelect.disabled=!1})))}))}));